from platform import system

from langchain_core.prompts import ChatPromptTemplate

system_prompt = ChatPromptTemplate.from_template("""
你是一个推荐手机流量套餐的客服代表，你叫南哥。
你可以帮助用户选择最合适的流量套餐产品。可以选择的套餐包括：
经济套餐，月费50元，10G流量；
畅游套餐，月费180元，100G流量；
无限套餐，月费300元，1000G流量；
校园套餐，月费150元，200G流量，仅限在校生。
记住：回复时要求你使用口语，亲切一些。不用说“抱歉”。直接给出回答，不用在前面加“南哥说：”。
""")


# greeting_card_prompt = ChatPromptTemplate.from_template("""
# "用户预定了一个餐厅包间，并且生成了餐厅邀请函，现在需请你根据场景生成：150字左右的用餐邀请语模板"
# "场景：{scenario}"
# "1）不要有关于人物的称呼，时间，地点等；
# 2）用词的语气要符合场景特性；例如：针对商务宴请，需要尽可能地正式，书面；针对朋友小聚，用词应该尽量亲昵等等；
# 3）你输出的信息，只保留邀请语内容，不要有其他的提示或者备注。
# """)

greeting_card_prompt = ChatPromptTemplate.from_template("""
请严格按普通文本的格式在一行内输出，根据场景生成140字的邀请语核心内容：
注：不用出现地点、时间、标题等
场景：{scenario}
""")

# greeting_card_prompt = ChatPromptTemplate.from_template("""
# "请根据以下场景生成一句不超过150字的邀请词："
# "场景：{scenario}"
# "要求：温暖、积极、贴合场景，且控制在120~150字之间。"
# """)

user_prompt = ChatPromptTemplate.from_template("""
用户问：{query}""")

test_prompt = ChatPromptTemplate.from_template("""
你是一位经验丰富的物流与供应链专家，精通TMS与运输调度。现有一套标准的运输管理系统，为了实现数据导入，你需要从给出的Excel表格中，根据字段名称（称之为"个性化字段"）及样本数据的特征，推测和理解字段的本质，并将其映射到标准系统的字段名称（称之为"标准化字段"）。如果识别不到，请输出提示。

需要识别并转化到现有系统的标准化字段如下: ["运输日期", "订单号", "路顺", "承运商", "运单号","车型", "发货方编号","发货方名称", "收货方编码","收货方名称", "商品编码"，"商品名称"，"件数", "体积", "重量"]。

**🚨 特别重要：数量字段（件数、体积、重量）是物流运输的核心数据，请务必仔细识别！**
**🔥 关键提示：这些字段通常带有"总"、"合计"、"总计"等前缀或后缀，如"总体积"、"总重量"、"件数合计"等！**

**🚨 特别重要：商品字段（商品编码、商品名称）是商品明细的核心，请务必仔细识别！**
**🔥 关键提示：这些字段通常有英文名称，如"Item ID"、"Item Description"、"SKU"等，不要因为英文而忽略！**

希望你按照如下格式返回映射结果: {{"运输日期": "字段名称1", "运单号": "字段名称2", "订单号": "missing", …}}。其中，"字段名称1"等是指提供的Excel中的个性化字段名称，如果部分标准化字段识别不到可以匹配的个性化字段，则允许返回"missing"，切勿强行全量匹配，样本值都是空值的也无需映射。

**🚨 重要提醒：发货方和收货方识别是本次映射的关键任务！请务必仔细理解以下识别规则！**

**🔥 核心要点：**
- **Excel中的"站点"字段就是"发货方"！** 看到"站点编号"就映射"发货方编号"，看到"站点名称"就映射"发货方名称"！
- **Excel中的"送货点"字段就是"收货方"！** 看到"送货点编号"就映射"收货方编号"，看到"送货点名称"就映射"收货方名称"！

**🚨 重要区分：**
- **发货方** = 货物发出的地方（站点、仓库、配送中心、工厂等）
- **收货方** = 货物要送达的地方（送货点、收货点、目的地、客户点等）

以下一些经验供参考：
1. Excel表格中每个个性化字段都有独特的意义和用途，因此通常不会出现两个个性化字段匹配到一个标准化字段的情况，需要综合样例数据分析最合理的匹配方式；
2. 个性化字段的中英文名称可以便于理解业务含义，提供一定的参考性，但是切勿仅仅基于文字进行判断映射关系，而是要综合结合所有的字段名称以及参考数据的特征，然后做决定；

**3. 关于"发货方编号"和"发货方名称"识别的关键经验（请务必仔细理解并严格执行）：**
   - **站点/网点/门店/仓库/配送中心/工厂 = 发货方**，这是物流行业的基本常识！
   - **重要提醒：Excel中的"站点"字段就是"发货方"！**
   - 如果Excel中存在以下字段，请优先考虑映射为发货方：
     * **站点编号 → 发货方编号**（这是最常见的映射！）
     * **站点名称 → 发货方名称**（这是最常见的映射！）
     * 网点编号、网点名称
     * 门店编号、门店名称、店号、店名
     * 仓库编号、仓库名称、仓号、仓名
     * 配送中心编号、配送中心名称、DC编号、DC名称
     * 工厂编号、工厂名称、厂号、厂名
     * 发货点编号、发货点名称、始发点编号、始发点名称
   - 物流运输通常是"一对多"模式：从1个发货点（仓库/配送中心/工厂）发往多个收货点
   - 一份Excel中的发货点数量通常在1-5个，收货点数量会更多
   - 如果又出现“客户号”也有可能是发货方编号，但优先级低于上述字段
   - 如果出现提货点、发运点等，也有可能是发货方名称字段
   - 如果发现某个字段的值在Excel中重复出现且数量有限（1-5个），很可能是发货方信息
   - 发货方编号通常是字符串类型，发货方名称通常是自然语言描述
   - **特别注意：不要因为字段名称中没有"发货方"字样就放弃识别，要理解业务本质！**
   - **再次强调：看到"站点"就想到"发货方"！**

4. 关于"订单号"识别的经验：常见的个性化名称包括了"单号"、"订单号"、"运输订单"、"发运单"等等，容易跟"运单号"混淆，所以更加需要借助样本数据的值去辅助判断。真正的"订单号"通常出现在Excel表格中靠左边（甚至就在第一列），在大部分Excel表单中充当了key的角色。通常Excel中每一行是一个独立的订单，因此识别出来映射到"订单号"的字段，通常可以观察到该个性化字段的值在样例数据里也是每行不同的，即：呈现出唯一性；而如果该字段在若干行出现了重复，也不一定就排除其被映射为"订单号"的可能性，因为有时候Excel提供了订单行级别的明细，即每一行对应了一种具体的商品/SKU，因此如果可以在Excel中找到该行对应的商品/SKU，则可以进一步确认这张Excel表格是订单行级别的明细表格，对应的个性化字段依然可以被映射为标准化字段"订单号"。注意，"订单号"是表格中最重要的字段，因此一定不会是空值或者存在明显数据错乱的值；
5. 关于"运输日期"识别的经验：看到创建时间还有申请时间等直接排除，因为我们真正需要的是实际发运时间，宁愿missing也不要指认错误的！！！！物流行业的Excel表格中通常可能包括多个跟日期/时间相关的列，比如订单的创建时间、审核时间、调度时间、发运时间、签收时间等，并且这几个数值通常在时间上有一定的先后关系，时间间隔可能为0天也可能为1-3天，取决于不同场景下的时效要求，但是通常我们需要映射的字段是实际发运的时间，所以遇到订单创建时间等字段我们不需要。因为订单的创建、审核更多属于销售行为，而签收时间已经是运输动作完成的时刻，我们需要映射的是更加贴近货物发出的日期，这才是需要映射到"运输日期"的值；请注意，订单创建时间不是运输日期，如果出现了订单创建时间，那就需要去寻找要求送达日期等字段。
6. 关于"承运商"识别的经验：如果该Excel中的订单都是由同一家承运商（近义词：运输公司/供应商/分包承运商/指定承运商等）负责的，则该字段可能在Excel不出现，出现了也可能是同一个值；该值有一个很典型的特征，就是通常从名字可以判断是一家物流或者运输公司，具有比较典型的物流企业命名特征。但是不排除部分Excel中提供了承运商编码而非承运商的企业名称，这种情况下依然属于正确匹配。当既出现了承运商编号又出现了承运商名称的时候，优先匹配承运商编号；
7. 关于"车型"识别的经验：注意，车次不是车型！！！！还需要注意的是，配载方式内容跟车的类型以及温度相关也可以作为车型的映射。可以借助样本数据的值辅助判断，如：4.2/6.8/9.6等用车型长度命名的（近似的叫法也有4.2m、4m2、4米2等），也有常见的金杯车/依维柯/面包车等小车型，也包含挂车、半挂车、40GP/40HQ等集装箱车。在Excel表格中，该列的值去重后通常为1-10种，在同一张Excel表格中不应该有太多的不同车型。如果Excel中存在车型编号，并且车型编号与车型名称一一对应，则进一步确认了业务理解的正确性，此种情况下优先返回车型编号/车型代码；
8. 关于"收货方编号"和"收货方名称"识别的关键经验（请务必仔细理解并严格执行）：
   - **送货点/收货点/配送点/目的地/客户点 = 收货方**，这是物流行业的基本常识！
   - **重要提醒：Excel中的"送货点"字段就是"收货方"！**
   - 如果Excel中存在以下字段，请优先考虑映射为收货方：
     * **送货点编号 → 收货方编号**（这是最常见的映射！）
     * **送货点名称 → 收货方名称**（这是最常见的映射！）
     * 收货点编号、收货点名称
     * 配送点编号、配送点名称
     * 目的地编号、目的地名称
     * 客户编号、客户名称、客户号、客户名
     * 终端编号、终端名称
     * 门店编号、门店名称（如果明确是收货门店）
   - 收货方通常是最终客户或配送终端，数量较多且分散
   - 一份Excel中的收货方数量通常比发货方多很多
   - 如果发现某个字段的值在Excel中变化很大且数量很多，很可能是收货方信息
   - 收货方编号通常是字符串类型，收货方名称通常是自然语言描述
   - **特别注意：不要因为字段名称中没有"收货方"字样就放弃识别，要理解业务本质！**
   - **再次强调：看到"送货点"就想到"收货方"！**
   - **重要区分：**
     * "发货点"、"始发点"、"起运点"、"站点"、"仓库" → **发货方**
     * "送货点"、"收货点"、"目的地"、"客户点"、"配送点" → **收货方**
9. 关于"件数"、"体积"、"重量"识别的经验：这是非常重要的数量字段，请务必仔细识别！

**体积字段识别规则：**
- **常见命名变体**：体积、总体积、体积合计、体积总计、立方、立方米、m³、m3、容积、空间、体积量
- **英文变体**：Volume、volume、VOL、vol、CBM、cbm、Cubic、cubic
- **业务变体**：货物体积、商品体积、包装体积、运输体积、配送体积
- **数据特征**：数值型数据，通常为小数，单位可能是立方米、立方厘米等
- **识别技巧**：看到"体积"、"立方"、"m³"、"CBM"等关键词，优先考虑映射为"体积"

**重量字段识别规则：**
- **常见命名变体**：重量、总重量、重量合计、重量总计、公斤、千克、kg、KG、吨、斤、磅
- **英文变体**：Weight、weight、WT、wt、KG、kg、TON、ton、LB、lb
- **业务变体**：货物重量、商品重量、包装重量、运输重量、配送重量
- **数据特征**：数值型数据，通常为小数，单位可能是公斤、吨等
- **识别技巧**：看到"重量"、"公斤"、"kg"、"吨"等关键词，优先考虑映射为"重量"

**件数字段识别规则：**
- **常见命名变体**：件数、总件数、件数合计、件数总计、数量、总数量、箱数、总箱数、包数、总包数
- **英文变体**：Quantity、quantity、QTY、qty、Count、count、PCS、pcs、BOX、box
- **业务变体**：货物件数、商品件数、包装件数、运输件数、配送件数
- **数据特征**：数值型数据，通常为整数，也可能为小数（标准件数）
- **识别技巧**：看到"件数"、"数量"、"箱数"、"PCS"等关键词，优先考虑映射为"件数"

**重要提醒：**
- 这些字段通常有"总"、"合计"、"总计"等前缀或后缀，不要因为多了这些字就忽略！
- 优先选择空值率低、数据波动大的字段
- 如果多个候选字段，选择业务含义最明确的
- 体积和重量通常不会同时为0，如果发现这种情况需要进一步分析
10. 关于"商品编码"识别的经验：这是商品唯一标识符，非常重要！

**商品编码字段识别规则：**
- **中文命名**：商品编码、商品编号、货号、品号、产品编码、货物编码、SKU编码
- **英文命名**：Item ID、Item ID、Item Code、Product Code、SKU、sku、Product ID、Goods Code、Material Code
- **缩写变体**：ID、id、Code、code、SKU、sku、PID、pid
- **业务变体**：商品条码、产品条码、货物条码、商品代码、产品代码
- **数据特征**：通常是字符串，可能包含字母、数字、特殊字符，每行通常不同
- **识别技巧**：看到"Item ID"、"SKU"、"Code"、"编码"等关键词，优先考虑映射为"商品编码"

**商品名称字段识别规则：**
- **中文命名**：商品名称、商品描述、货名、品名、产品名称、货物名称、商品说明
- **英文命名**：Item Description、Item Desc、Product Name、Product Description、Goods Name、Material Description
- **缩写变体**：Desc、desc、Description、description、Name、name
- **业务变体**：商品描述、产品描述、货物描述、商品规格、产品规格
- **数据特征**：通常是文本描述，包含商品的具体信息，可能较长
- **识别技巧**：看到"Item Description"、"Desc"、"Name"、"名称"、"描述"等关键词，优先考虑映射为"商品名称"

**重要提醒：**
- 商品编码和商品名称通常成对出现，可以相互验证
- 英文字段如"Item ID"、"Item Description"是常见的商品字段，不要忽略！
- 这些字段帮助判断Excel是否为"订单行"级别的明细数据
- 如果发现商品字段，订单号字段的识别会更准确
12. 关于"运单号"识别的经验：行业里存在一些常见叫法，例如"运输单号"、"发运单号"、"委托单号"、"调度单号"、"派车单号"，等等，尤其"调度单号"、"派车单号"更加可以清晰地判定是对应了一个具体的车次。标准系统中，该列是代表是将货物安排装进一辆车的配载调度行为。相同"运单号"的多行订单，即可认为是配载进了一个车次。因此，正确匹配的列，其样本数据应该存在若干典型的特征：1）通常不会每行都是唯一值，而是若干行对应了一个相同的运单号值；2）由于相同运单号代表了同一个车次，因此其车型、承运商、发车日期、司机等与发车行为相关的值应该是相同的，反之，如果车牌号或者司机都不同的，肯定不是同一个车次，那么此时如何拟映射的运单号字段却是相同值，则可以断定该列不应该被映射为"运单号"；3）正确匹配的"订单号"与"运单号"应该呈现了"多对一"的关系，因此不要过分关注Excel表格中个性化字段的中文名，更应理解背后的业务含义，去判断正确的匹配方法；4）还需要注意车牌号不是运单号，司机也不是运单号，这两个字段通常是与运单号一一对应的辅助字段，如果Excel中提供了车牌号或者司机，则不应该将其映射为运单号。
13. 关于"路顺"识别的经验：即可理解为配送顺序字段。路顺是指同一个车次如果配送了多个地址，车辆按照什么顺序进行送货。该字段是一个相对次要的值，只有当Excel中提供了"运单号"后，路顺的值才可能提供，或者才可能有意义。否则如果无法判断哪些订单是由同一辆车运输的，路顺毫无意义。路顺通常用数字表示，并且同一个运单内不同送货地址对应的值应该不同、相同地址对应的路顺应该相同。

在返回的结果中，除了标准化映射结果，需要汇总映射依据及关键分析，便于人工复核。同时，将提醒类的事项汇总返回，包括没有成功匹配的标准字段名称、关键数值的缺失、体积与重量单位不是标准的立方米或者KG需要提醒转化，以及其他你认为需要提醒工程师的内容，简要描述。

最后，将本次映射解析工作的预估准确率给出一个0-100的分数，便于工程师判断本次智能映射工作的可信度。

当前Excel数据（JSON格式）：
{excel_data}

**重要说明**：如果数据中包含"截断说明"字段，说明原始数据量过大，LLM无法处理完整数据。此时请基于提供的样本数据和统计信息进行字段映射分析，并在分析结果中说明数据截断对映射准确性的影响。

请严格按照上述JSON结构输出结果。
""")